version: '3.9'

services:
  superset:
    build:
      context: . 
      dockerfile: Dockerfile.superset
    container_name: superset_app
    ports:
      - "8088:8088" 
    volumes:
      - superset_data:/app/superset_home 
    environment:
      - SUPERSET_LOAD_EXAMPLES=no
      - "SUPERSET_SECRET_KEY=XykAkq0XbYII8k+S9C7u+reGbd/hia4TxuMIQmj8QsiflSy65lCXWedC"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  superset-init:
    build:
      context: .
      dockerfile: Dockerfile.superset
    container_name: superset_init
    command: >
      bash -c "
        echo 'Waiting for Superset to be healthy...' &&
        until curl -f http://superset:8088/health; do
          sleep 5
        done &&
        echo 'Initializing database and admin user...' &&
        superset db upgrade &&
        superset fab create-admin --username admin --firstname Superset --lastname Admin --email admin@superset.com --password admin &&
        superset init
      "
    volumes:
      - superset_data:/app/superset_home
    
    environment:
      - SUPERSET_LOAD_EXAMPLES=no
      - "SUPERSET_SECRET_KEY=XykAkq0XbYII8k+S9C7u+reGbd/hia4TxuMIQmj8QsiflSy65lCXWedC"

    depends_on:
      superset:
        condition: service_healthy

volumes:
  superset_data:
    driver: local